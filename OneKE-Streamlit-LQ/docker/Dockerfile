# OneKE-Streamlit-Frontend ä¸“ç”¨ç¯å¢ƒ
# OneKE é¡¹ç›®ä»…ä½œä¸ºä»£ç ä¾èµ–ï¼Œä¸éœ€è¦å•ç‹¬ç¯å¢ƒ

FROM python:3.9-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app/OneKE/src:/app/OneKE-Streamlit-Frontend
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    git \
    wget \
    curl \
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    libssl-dev \
    libffi-dev \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    libjpeg-dev \
    libpng-dev \
    libfreetype6-dev \
    liblcms2-dev \
    libwebp-dev \
    tcl8.6-dev \
    tk8.6-dev \
    python3-tk \
    libharfbuzz-dev \
    libfribidi-dev \
    libxcb1-dev \
    vim \
    nano \
    htop \
    tree \
    && rm -rf /var/lib/apt/lists/*

# å‡çº§pip
RUN pip install --upgrade pip setuptools wheel

# å¤åˆ¶å‰ç«¯é¡¹ç›®çš„requirementsæ–‡ä»¶
COPY ../OneKE-Streamlit-Frontend/requirements.txt /tmp/requirements.txt

# å®‰è£…å‰ç«¯é¡¹ç›®ä¾èµ–ï¼ˆè¿™æ˜¯å”¯ä¸€éœ€è¦çš„Pythonç¯å¢ƒï¼‰
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
RUN rm /tmp/requirements.txt

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/data /app/logs /app/uploads /app/models

# è®¾ç½®æƒé™
RUN chmod -R 755 /app

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "=== OneKE-Streamlit-Frontend ç¯å¢ƒå·²å¯åŠ¨ ==="\n\
echo "å·¥ä½œç›®å½•: /app"\n\
echo ""\n\
echo "ğŸ“‹ é¡¹ç›®è¯´æ˜:"\n\
echo "  ğŸ¯ ä¸»é¡¹ç›®: OneKE-Streamlit-Frontend (å‰ç«¯åº”ç”¨)"\n\
echo "  ğŸ“š ä¾èµ–é¡¹ç›®: OneKE (ä»£ç åº“ï¼Œä¸éœ€è¦ç‹¬ç«‹è¿è¡Œ)"\n\
echo ""\n\
echo "ğŸŒ å¯ç”¨æœåŠ¡:"\n\
echo "  ğŸ“Š Streamlit å‰ç«¯: http://localhost:8501"\n\
echo "  ğŸ—„ï¸  Neo4j æ•°æ®åº“: http://localhost:7474"\n\
echo ""\n\
echo "âœ… Python ç¯å¢ƒ: oneke-frontend (å·²é…ç½®å®Œæˆ)"\n\
echo "ğŸ“¦ ä¾èµ–çŠ¶æ€: å·²å®‰è£…å‰ç«¯é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰åŒ…"\n\
echo ""\n\
echo "ğŸš€ å¯åŠ¨ Streamlit åº”ç”¨..."\n\
cd /app/OneKE-Streamlit-Frontend\n\
streamlit run app.py --server.port=8501 --server.address=0.0.0.0 --server.headless=true' > /app/start.sh

RUN chmod +x /app/start.sh

# æš´éœ²ç«¯å£
EXPOSE 8501

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8501/_stcore/health || exit 1

# é»˜è®¤å¯åŠ¨å‘½ä»¤
CMD ["/app/start.sh"]